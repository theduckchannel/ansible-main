---
- hosts: localhost
  vars: 
      install_drive: /dev/sda
      efi_partition: /dev/sda1
      system_partition: /dev/sda2
      hostname: duckbox
      timezone: America/Sao_Paulo
  tasks:
    - name: Abort if the host is not booted from the Arch install media
      fail:
        msg: "This host is not booted from the Arch install media!"
      when: ansible_nodename != 'archiso'
      tags:
        - quick_exit
    - name: Load my keyboard Layout
      command: loadkeys br-abnt2
    - name: Synchronize clock via NTP
      command: timedatectl set-ntp true
      tags:
        - sync_clock
    - name: Wipe all partitions
      command: wipefs --force --all "{{install_drive}}"
      tags:
        - wipefs
    - name: Zap all partitions
      command: sgdisk -Z "{{install_drive}}"
      tags:
        - sgdisk


    - name: Create EFI partition
      community.general.parted:
        device: "{{install_drive}}"
        name: EFI
        label: gpt
        part_end: 512MiB
        flags: [boot, esp]  
        number: 1
        state: present


    - name: Create System partition
      community.general.parted:
        device: "{{install_drive}}"
        name: System
        part_start: 512MiB
        label: gpt
        number: 2
        state: present

    - name: Formatting
      block:
        - name: Formatting efi partition
          filesystem:
            dev: "{{efi_partition}}"
            fstype: vfat
            opts: -F32
            force: yes

        - name: Formatting system partition
          filesystem:
            dev: "{{system_partition}}"
            fstype: btrfs
            force: yes


    - name: Mounting Filesystems
      block:
        - name: Mount System Partition
          mount:
            path: /mnt
            src: "{{system_partition}}"
            opts: rw
            fstype: btrfs
            state: present


